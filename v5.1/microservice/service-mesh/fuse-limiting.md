---
title: 熔断，限流
summary: 熔断器与限流
toc: false
toc_not_nested: true
asciicast: true
---

### 概述

熔断其实类似日常生活中的“保险丝”，一个用户请求的调用，在微服务内部可能是多个服务之间的连环调用，若其中一个或几个服务产生了系统瓶颈，就会导致超时，这样会阻碍整体调用链的调用进度，从而导致整个系统连接数过多，造成系统瘫痪，那么熔断要做的就是当发现某一服务的错误、超时、负载，达到某一指标时候来拦截后续的请求。当服务产生熔断后，那么就需要对服务进行降级，降级可以立即给用户一个返回，及时的返回空白内容或是错误信息。顾名思义限流就是限制请求的qps，将请求的数量控制在该服务可以接受的范围内。我们平台提供`服务网络治理插件`，应用Envoy通过配置各下游应用的参数，来实现微服务治理，并对修改实时生效，不影响业务的正常运行。



### 使用插件

在团队中的`我的插件`中安装`服务网络治理插件`，在上游应用的`扩展`板块中开通此插件，点击查看配置，为你的下游应用配置相应的参数，来实现服务的异常检测，熔断，与限流。

<img src="https://static.goodrain.com/images/docs/3.6/basic-operation/advanced-operation/extended.jpg" style="border:1px solid #eee;width:100%">



### 如何使用

异常值检测和逐出是动态确定上游群集中，某些主机是否正在执行不同于其他主机的过程，并将其从正常负载平衡集中移除。 性能可能会受到不同程度的影响，例如连续的故障，时间成功率，时间延迟等。异常检测是被动健康检查的一种形式。熔断是分布式系统的重要组成部分。快速失败并尽快给下游施加压力，几乎总是好的。在网络级别实现强制断路限制，而不必独立配置和编写每个应用程序。尽管分布式熔断在控制分布式系统中的吞吐量方面通常是非常有效的，但是有时并不是非常有效，所以需要全局速率限制。

<img src="https://static.goodrain.com/images/docs/3.6/basic-operation/advanced-operation/config.jpg" style="border:1px solid #eee;width:100%">

#### 配置说明

- LIMITS：TCP限速，设置值为0则熔断，HTTP类型应用，配置LIMITS不受影响
- MaxPendingRequests：HTTP最大挂起请求数，设置值为0则挂起请求
- MaxRequests：在任何给定时间，可以处理的最大请求数
- MaxConnections：最大连接数，为上游群集中的所有主机建立的最大连接数
- MaxEjectionPercent：最大降级节点百分比，比如您有十个节点，最大降级节点单百分比为20%，那么最大降级节点为2
- ConsecutiveErrors：连续错误降级阀值。当下游服务错误率到达一个阀值，将上游请求快速失败返回，保护上游服务稳定，同时又不给下游服务增加压力，做到快速失败、快速返回。
- MaxActiveRetries：在任何给定时间，集群中所有主机可以执行的最大重试次数，达到设置值请求将被熔断
- IntervalMS：被逐出后多少秒(s)后自动重新投入使用
- BaseEjectionTimeMS：降级基准时间(ms)，主机被逐出几毫秒。意味着主机被标记为不健康，在负载平衡期间不会使用，除非负载平衡器处于紧急情况。毫秒数等于BaseEjectionTimeMS值乘以主机被逐出的次数。这会导致主机如果继续失败，则会被逐出更长和更长的时间。
