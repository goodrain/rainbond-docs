---
title: 服务路由，灰度发布，A/B测试
summary: 服务路由，灰度发布，A/B测试
toc: false
toc_not_nested: true
asciicast: true
---

### 概述

路由（routing）是指分组从源到目的地时，决定端到端路径的网络范围的进程 。路由工作在OSI参考模型第三层—网络层的数据包转发设备。路由器通过转发数据包来实现网络互连。Rainbond默认的代理插件支持4层负载均衡，借助Service Mesh便于扩展得特性，我们可以再针对各种应用层协议匹配不同的网络治理插件，实现7层负载均衡，例如HTTP、gRPC、Redis等协议。Rainbond目前提供“基于envoy的7层网络治理插件”（envoy本身可以与安生运行于Rainbond插件体系之中），用户也可以选择和实现其他插件，Rainbond运行时将提供完善的基础服务。 

通过我们提供的` 服务网络治理插件 `，使你可以快速的为下游应用配置路由信息，并通过合理的配置，来简单快速的实现应用的灰度发布与A/B测试的功能，接下来我们已HTTP协议为例，来说下具体的使用。



###  使用插件

> 安装插件

首先需要你在`我的插件`中安装插件`服务网络治理插件`，然后在您的上游应用中`扩展`一栏中开通此插件。

<img src="https://static.goodrain.com/images/docs/3.6/basic-operation/advanced-operation/extended.jpg" style="border:1px solid #eee;width:100%">

> 配置路由信息

- 选择要配置的下游应用，并指定端口号

- PREFIX：URL前缀path配置，例如/api
- DOMAINS：内网请求域名配置，基于配置的域名转发至下游应用，仅支持一级域名
- WEIGHT：转发权重设置，范围1~100。规定相同的DOMAINS与PREFIX组合情况下，权重总和为100。数值越大，权重越高。
- HEADERS：HTTP请求头设置，多个参数以;分隔

<img src="https://static.goodrain.com/images/docs/3.6/basic-operation/advanced-operation/config.jpg" style="border:1px solid #eee;width:100%">

> 说明

* 权重：权重是一个相对的概念，针对某一指标而言。某一指标的权重是指该指标在整体评价中的相对重要程度。权重是要从若干评价指标中分出轻重来，一组评价指标体系相对应的权重组成了权重体系。
* 依赖服务治理中未指明其他内部域名与前缀关系的权重，则访问其他接口不受权重影响





### 灰度发布

灰度发布主要是按照一定策略选取部分用户，让他们先行体验新版本的应用，通过收集这部分用户对新版本应用的反馈，以及对新版本功能、性能、稳定性等指标进行评论，进而决定继续放大新版本投放范围直至全量升级或回滚至老版本。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。灰度发布的优点大概有体现在以下几点：

1. 提前获得目标用户的使用反馈
2. 根据反馈结果，做到查漏补缺
3. 发现重大问题，可回滚“旧版本”
4. 补充完善产品不足
5. 快速验证产品的 idea

我们云帮支持通过简单的配置帮您实现灰度发布的需求。

<img src="https://static.goodrain.com/images/docs/3.6/basic-operation/advanced-operation/selector.png" style="border:1px solid #eee;width:100%">



> 使用

您可以通过各下游应用的`DOMAINS`与`PREFIX`相同的情况下，给`WEIGHT(权重值)`参数分配不同的数值来控制各下游应用的流量转发，流量会按照你各下游应用权重值的占比来进行流量切分，比如您可以先让一部分用户体验到新版本的功能，以此来实现灰度发布的功能，通过对新版本的观察，进而决定继续全量升级或回滚应用。 



### A/B测试

对照实验，也叫随机实验和A /B测试。在软件开发中，产品需求通过多种技术手段来实现。 A/B测试实验提供了一个有价值的方式来评估新功能对客户行为的影响。 运行网站和服务的A/B测试实验能力，从而可以用更科学方法来评估规划过程中不同阶段的想法价值。一屋子人拍桌子瞪眼的争辩到底哪个设计好？哪个文案好？哪个执行策略有效，还不如让真实的用户和数据来告诉你答案。 

<img src="https://static.goodrain.com/images/docs/3.6/basic-operation/advanced-operation/ab.jpg" style="border:1px solid #eee;width:100%">

> 使用

你可以通过配置您的下游应用参数来灵活的管理你的下游应用，例如在`权重WEIGHT`相同的情况下，你可以为不同的下游应用分别设置不同的`HEADERS`值，根据请求HEADERS中的值来决定此次请求应该被分流到哪个具体的个下游应用中，让不同的用户按你的要求分别下发到不同的下游应用，以此来方便实现您的A/B测试功能。 



### 其他

关于服务网络治理插件中的其他参数与作用，我们将在`断路器,限流 `一篇中为你解答。