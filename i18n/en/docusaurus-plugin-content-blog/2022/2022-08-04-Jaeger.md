---
title: Distributed link tracks Jaeger + Microservice Pig's practice sharing on Rainbond
description: As the microservice architecture is popular, a request from a client may need to involve multiple or N services, making our monitoring and scheduling between services more complex
slug: jaeger
image: https://static.goodrain.com/wechat/jaeger/jaeger-cover.png
---

As the microservice structure is popular, a request by a client may need to involve multiple or N services, making our monitoring and scheduling between services more complicated.

**Take an example：**

A particular interface of a business line calls services at a fast and slow pace, which will require a log analysis of the services and the mobilization of developers of each service that is time-consuming and expensive.Logs are sometimes not available for ToB's business, it's hard to do!

Therefore, there is a need to help understand system behaviour and tools used to analyse performance issues so that problems can be quickly positioned and resolved in case of failure, namely APM (Application Performance Monitor).There are many popular APM open source tools such as：Zipkin, Skywalking, Pinpoint, Jaeger et al.

Jaeger is an open source distribution tracking system issued by the Uber Technical Team for monitoring and troubleshooting microservices-based distribution system：

- Distributed Context Transmission and Transaction Monitor
- Analysis of root causes, service dependency
- Performance / Delay Optimization
- Data-inspired model [OpenTracing](http://opentring.io/)
- Multiple storage backend：Cassandra, Elasticsearch, memori.
- System topography
- Service Performance Monitor (SPM)
- Adaptive sample

## Jaeger architecture

![](https://static.goodrain.com/wechat/jaeger/1.png)

| Component                                     | Description                                                                                                                        |
| --------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| Jaeger Client                                 | Jaeger Client SDK                                                                                                                  |
| Jaeger Agent                                  | Collect Client Data                                                                                                                |
| Jaeger Collector                              | Collecting data from Jaeger Agent, in both ways                                                                                    |
| DB Store                                      | Collector needs to store the backend, and the data obtained by collector will exist in Elasticsearch or Cassandra. |
| Spark jobs                                    | Used to generate topographic UI data                                                                                               |
| Jaeger Query Service & UI | Responsible for searching data from Storage and providing API and UI                                                               |

## How do I integrate on Rainbon?

![](https://static.goodrain.com/wechat/jaeger/2.png)

**1.Integrate OpenTelemetry Client：**

v1.36 The previous version of Jaeger Client is a client library based on the `OpenTracing API`. Jaeger Client combined with Jaeger Agent and sent to Jaeger Collector.

v1.36 is deactivated later.Use [OpenTelemetry](https://opentelemetry.io/) instead of Jaeger Client and Jaeger Agent, see [Jaeger and OpenTelemetry](https://medium.com/jaegertracing/jaeger-and-opentelemetry-1846f701d9f2).

`OpenTelemetry` is invalid, just add `javaagent` when Java process starts, for example：`java -javaagent:path/to/opentelemetry-javaagent.jar -jar myapp.jar`.

On Rainbond then you can download `OpenTelemetry javaagent` to the component and modify the launch command.

**2.Connect to Jaeger-Collector：**

All microservice components that install the `OpenTelemetry javaagent` plugin are connected to `Jaeger Collector`.

## Practical steps

Demo will use Spring Cloud Pig, Gitee：https://gitee.com/zhangbigqi/pig

Rainbond deployment is available in document [快速安装](https://www.rainbond.com/docs/quick-start/quick-install).

### Spring Cloud Pig source deployment

The `Spring Cloud Pig` microservice framework is not detailed by source deployed, see：

- [Spring Cloud Pig Deploy tutorial](https://t.goodrain.com/d/3-springcloud-pig-rainbond)
- [Spring Cloud Pig Video Tutorial](https://www.bilibili.com/video/BV1MZ4y1b7wW)

### 2. OpenTelemetry Plugin Installation

Install the `opentelemetry-java-agent` initialization plugin from the App Store. The function of this plugin is to download `opentelemetry-javaagent.jar` to the microservice component, which can be specified in the Java startup item.

- Team View -> Plugin -> Install Plugins from App Store -> Search for `opentelemetry-java-agent` and install.

![](https://static.goodrain.com/wechat/jaeger/3.png)

### Deployment of Jaeger

Search for `Jaeger` in the open source store and install it to the specified app.

![](https://static.goodrain.com/wechat/jaeger/4.png)

### OpenTelemetry Agent Plugin Configuration

**1.enter OpenTelemetry Agent plugin**

For example `pig-gateway`, open `opentelemetry-java-agent` in the component -> plugin and update the component to take effect. Other components within the microservice need to open the plugin and update or restart the component to take effect.

![](https://static.goodrain.com/wechat/jaeger/5.png)

**2. Configure environment variables**

Configure environment variables for all microservice components.

| Variable Name                                                                                | Variable value                                                                                                           | Note                                      |
| -------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------- |
| OTH_NOTIF_POPUP_TITLE         | jaeger                                                                                                                   | Select Jaeger exporter                    |
| OTEL_EXPORTER_JAEGER_ENDPOINT | http://127.0.0.0.1:14250 | Jaeger Collector gRPC endpoint            |
| OTH_EXPORTER_JAEGER_TIMEOUT   | 10000                                                                                                                    | Timeout (milliseconds) |
| VIP_POPUP_TITLE                                    | none                                                                                                                     | Metrics Exporter                          |
| JAVA_OPTS                                                               | -javaagent:/agent/opentelemetry-javaagent.jar                                            | Java Start Parameters                     |

Use the `App Config Group` to configure and apply to all components.

![](https://static.goodrain.com/wechat/jaeger/6.png)

**3. Configure component service name**

Configure the environment variable `OTEL_SERVICE_NAME for all microservice components, the name of the Jaeger service for the component, e.g.：`OTEL_SERVICE_NAME=pig-gateway` `OTEL_SERVICE_NAME=pig-auth \`

### Building dependencies

Connect all microservice components to `Jaeger Collector`.

The `Jaeger` component can be seen in the current app's sketch and the remaining components can be connected by the topographic mode of the top.Update or restart all microservice components for dependencies to take effect.

![](https://static.goodrain.com/wechat/jaeger/7.png)

### Jaeger Quick Use

1. Visit Spring Cloud Pig UI to log in to generate data.

2. Visit the `16686` port of `Jaegeer-Query` to `Jaeger UI` by opening the external service.

3. Search for Pig-gateway Traces on Jadeger Search

   - Service：Select a Microservice Component
   - Operation：Select Operation Type, Example：GET POST, Interface, class...
   - Tags：filtered by response header, Example：http.status_code=200 error=true
   - Lookback：Select Time
   - Max Duration：max;Min Duration：minimum duration.
   - Limit Results：limits the number of returned results.

![](https://static.goodrain.com/wechat/jaeger/10.png)

4. Find Pig-gateway HTTP POST Traces and include pig-auth Span and enter, see a clear display of a layer of calls between services and response time for interface, so we can find out which service calls are slow or wrong calls.

![](https://static.goodrain.com/wechat/jaeger/11.png)

**Jaeger topography generation**

The plot will not be generated by default. Use the `spark-dependencies` component to generate the topographic data, a Spark job that collects span from storage, analyzes links between services and stores them for later display in the UI.See [Jaeger Spark dependencies] (https://github.com/jaegertracing/spark-dependencies).

The `spark-dependencies` component takes up a larger resource, can be turned off when it is not used, and starts when the topographic data is generated.

![](https://static.goodrain.com/wechat/jaeger/9.png)

## Last

Having an APM system that allows us to better analyze business performance, troubleshooting, etc.

Combining Rainbond as a base seat, be it `Spring Cloud` or `Jaeger` or other \`\`APM\`, can be easily and quickly deployed, freeing up from onerous deployments, configurations and more attention to the business layer.
