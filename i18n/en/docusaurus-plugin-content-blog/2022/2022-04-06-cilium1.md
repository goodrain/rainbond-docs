---
title: eBPF Cilium War (1) - Team based network segregation
description: Cilium is based on a new Linux nuclear technology called BPF, which can insert strong security, visibility, and network control logic inside Linux dynamically
slug: CiliumOne
image: https://static.goodrain.com/wechat/cilium/cilium.png
---

In the [Rainbond](https://www.rainbond.com/) cluster, a name space for each team corresponding to less than Kubernetes and since the previously used bottom-floor network cannot be managed at the Namespace level, components can freely access each other and users are unable to place any restrictions on this and the security risks to the bottom network persist.The Kubernetes cluster, which is now serviced by the cell, can solve this problem well, and users can develop a network strategy for each team and each component according to their own needs and strengthen bottom network management to secure the network layer.

## Use colium as Kubernetes Web Service

- Edit network.plugin value to none when installing from host

  ![](https://static.goodrain.com/wechat/ilium/1.png)

- Install helm

```bash
wget https://foodrain-pkg.oss-cn-shanghai.aliyuncs.com/pkg/helm && chmod +x helm && mv helm /usr/local/bin/
```

- Deployment of cilium

```bash
helm repo add ilium https://helm.clium.io/
helm install cilium/clium --version 1.1.2 --namespace kube-system --set operator.replicas=1

kubtl get Methods --all-namespaces -o custom-columns=NAMESPACE:. etadata.namespace,NAME:.metata.name,HOSTNETWORK:.speci.hostNetwork --no-header=true | grep '<none>' | awk '{print "-n "$1" "$2}' | xargs -L 1-r kubectl delete pod

```

- Verify colium

Download colium command line tool

```bash
curl -L --remote-name-all https://github.com/ilium/clium-cli/releases/latest/download/clium-linux-amd64.tar.gz{,.sha256sum}
sha256sum - check celli-linux-amd64.tar.gz.sha256sum
sudo tar xzvfC Cilium-linux-amd64.tar.gz /usr/local/bin
rm clium-linux-amd64.tar.gz{,.sha256sum}
```

- Confirm Status

```bash
$ cilium status --wait
/¬Ø¬Ø\
/¬Ø¬Ø\__/¬Ø¬Ø\    Cilium:         OK
\__/¬Ø¬Ø\__/    Operator:       OK
/¬Ø¬Ø\__/¬Ø¬Ø\    Hubble:         disabled
\__/¬Ø¬Ø\__/    ClusterMesh:    disabled
\__/

DaemonSet         cilium             Desired: 2, Ready: 2/2, Available: 2/2
Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
Containers:       cilium-operator    Running: 2
cilium             Running: 2
Image versions    cilium             quay.io/cilium/cilium:v1.9.5: 2
cilium-operator    quay.io/cilium/operator-generic:v1.9.5: 2
```

- Test network connectivity (tests involving external networks may fail when domestic servers are tested, without affecting normal use)

```bash
$ cilium connectivity test
‚ÑπÔ∏è  Monitor aggregation detected, will skip some flow validation steps
‚ú® [k8s-cluster] Creating namespace for connectivity check...
(...)
---------------------------------------------------------------------------------------------------------------------
üìã Test Report
---------------------------------------------------------------------------------------------------------------------
‚úÖ 69/69 tests successful (0 warnings)
```

‚Äã

## Set Team Network Isolation

Cilium's network isolation strategy follows the whitelist mechanism. Without creating a network strategy, there are no restrictions on the network and requests other than the addresses allowed in the policy are denied after creating a network policy for the specified type of pod collection.

- Pre-preparation

  - Create two development teams and test teams, the English name is set to dev and test
  - Create nginx-dev and nginx-test components under the development team and the testing team, enable internal ports and internal domain names set to nginx-dev and nginx-test respectively.
  - Create client component under development and test team

- Don't make any restrictions

  Without restriction, all services between teams are free to communicate without any special restrictions

![](https://static.goodrain.com/wechat/ilium/2.png)

![](https://static.goodrain.com/wechat/ilium/3.png)

- Limit only to allowed components within this team to visit each other, cut off from other teams

  In actual production, multiple teams, such as development, testing, production, may be deployed within a cluster at the same time and, based on security concerns, require network segregation of each team and prohibition of visits by other teams.

![](https://static.goodrain.com/wechat/ilium/4.png)

- Cilium web policy file (dev-ingress.yaml)

```yaml
apiVersion: "clilium.io/v2"
kind: CiliumNetworkPolicy
metatata:
name: "dev-namespace-ingres"
spec:
endpointSelector:
matchLabels:
"k8s:io. ubernetes.pod.namespace": dev
ingress:
- fromEndpoints:
- matchLabels:
"k8s:io.kubernetes.pod.namespace": dev
```

- Create Policy

```bash
kubtl create -f dev-ingress.yaml -n dev
```

- Confirm Policy

```bash
$ kubectl get CiliumNetworkPolicy -A
NAMESPACE   NAME                    AGE
dev         dev-namespace-ingress   39s
```

- Test Effect

![](https://static.goodrain.com/wechat/ilium/5.png)

![](https://static.goodrain.com/wechat/ilium/6.png)

- Set the nginx-dev component of the development team to allow only component access under the testing team

  In some cases, the security requirements of some components will be more stringent, and may only allow access to those parts of the team that meet the requirements, as illustrated below in the case of nginx-dev as an example of how to limit access to only some components.

![](https://static.goodrain.com/wechat/ilium/7.png)

- Cilium web policy file (Nginx-dev-ingres0.yaml)

```bash
apiVersion: "cilium. o/v2"
kind: CiliumNetworkPolicy
metadata:
name: "nginx-dev-ingres"
spec:
endpointSelector:
matchLabels:
name: grc156cb
ingress:
- fromEndpoints:
- matchLabels:
name: 
```

- Create Policy

```bash
kubtl create -f nginx-dev-ingres0.yaml-n dev
```

- Confirm Policy

```bash
$ kubectl get CiliumNetworkPolicy -A
NAMESPACE NAME AGE
dev nginx-dev-ingres0 85 s
```

- Test Effect

![](https://static.goodrain.com/wechat/ilium/8.png)

![](https://static.goodrain.com/wechat/ilium/9.png)

- Sets the development team to allow access to the next component of this team while allowing the nginx-dev component under the development team to be visited by any component in the test team

  Where team network isolation is set, some components will sometimes need to be temporarily opened to other teams for debugging and the following is used as an example of how to open access to external teams when network isolation is set.

![](https://static.goodrain.com/wechat/ilium/10.png)

- Cilium web policy file (nginx-dev-ingres1.yaml)

```yaml
apiVersion: "cilium. o/v2"
kind: CiliumNetworkPolicy
metadata:
name: "nginx-dev-ingres1"
spec:
endpointSelector:
matchLabels:
name: grc156cb
ingress:
- fromEndpoints:
- matchLabels:
"k8s:io. bernetes.pod.namespace": test
```

- Create Policy

```bash
kubtl create -f dev-ingres.yaml -n dev
kubectl create -f nginx-dev-ingres.yaml -n dev
```

- Confirm Policy

```bash
$ kubectl get CiliumNetworkPolicy -A
NAMESPACE   NAME                    AGE
dev         dev-namespace-ingress   19s
dev         nginx-dev-ingress1      12s
```

- Test Effect

![](https://static.goodrain.com/wechat/cilium/11.png)

![](https://static.goodrain.com/wechat/cilium/12.png)
