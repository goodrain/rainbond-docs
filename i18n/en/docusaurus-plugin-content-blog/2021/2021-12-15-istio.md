---
title: Implementation of Istio under the Rainbond Service Mesh system
description: The service grid is the final form of the microservice architecture, but it is not easy to use because the structure is coupled, but deployment has not been decoupled.
slug: istio
image: https://static.goodrain.com/wechat/istio/istio.jpeg
---

:::info Two years ago, Service Mesh (Service Mesh) became popular as soon as it came out. Many people think it is the final form of microservice architecture, because it can decouple business code from microservice architecture, that is, business The code does not need to be modified to implement the microservice architecture, but the decoupling is not thorough enough, and it is still inconvenient to use. Although the architecture is decoupled, the deployment has not been decoupled.

- It is impossible to choose a suitable Service Mesh framework according to different environments or customer needs.
- It is impossible to learn and use Service Mesh in the development environment, and enable the production environment on demand. :::

<!--truncate-->

## Plug-in Service Mesh Architecture Implementation Ideas

目前成熟的ServiceMesh框架也有许多，但是对于用户而言。并不存在万能的ServiceMesh框架，可以解决各种场景的问题。因此我们希望对于用户而言，他只需要关心自己的业务代码。而应用的治理能力，则可以通过不同的ServiceMesh框架进行拓展。There are also many mature ServiceMesh frameworks, but for users.There is no omnipotent ServiceMesh framework that can solve problems in various scenarios.Therefore, we hope that for the user, he only needs to care about his business code.The application governance capabilities can be expanded through different ServiceMesh frameworks.The user's business code is completely decoupled from the ServiceMesh framework.As shown below.Users can replace the ServiceMesh architecture used by an application at any time.Choose the solution that best matches your business.如下图所示。用户可以随时替换某个应用所使用的ServiceMesh架构。选择与业务最匹配的解决方案。

![image-20211211180131913](https://cdn.jsdelivr.net/gh/yangkaa/images@main/works/image-20211211180131913.png)

Based on the above ideas, we can make istio, linkerd, dapr and other microservice architectures into plug-ins. During the development process, we do not need to know the existence of the Service Mesh framework. We only need to deal with the dependencies of the business. When delivering to the production environment or customer environment , some require high performance, some require full functions, and some customers have specified various requirements. You can open different types of plug-ins as needed according to the environment and customer needs. When there is a problem with the Service Mesh framework, you can switch it at any time.In this way, the Service Mesh framework becomes an enabling tool, and the redeployment of the old business system can immediately open the service governance capability.这样Service Mesh框架就变成赋能的工具，老的业务系统重新部署马上就能开启服务治理能力。

Rainbond is implemented based on the above ideas. The current version has implemented three service governance plug-ins.

- kubernetes native service mode
- Envoy-based Service Mesh Mode
- Istio service governance model

Later, we will explain in detail the process of using the Istio service governance model.

## Practice using the Istio governance model

有了以上概念，我们可以来看看Rainbond如何与Istio结合。在Rainbond中，用户可以对不同的应用设置不同的治理模式，即用户可以通过切换应用的治理模式，来按需治理应用。这样带来的好处便是用户可以不被某一个ServiceMesh框架所绑定，且可以快速试错，能快速找到最适合当前业务的ServiceMesh框架。

### Install the Istio control plane

首先在切换到Istio治理模式时，如果未安装Istio的控制面，则会提示需要安装对应的控制面。因此我们需要安装Istio的控制面，控制面在一个集群中只需安装一次，它提供了统一的管理入口，用来管理工作在Istio治理模式下的服务。完成配置下发等功能。结合Rainbond现有的helm安装方式，我们可以便捷的安装好对应的组件。

#### 1. Create a team

在5.5.0版本中，我们支持了用户在创建团队时指定命名空间。由于默认helm安装的命名空间为 istio-system ，所以为了减少用户配置。我们首先需要创建出对应的团队。如下图所示。团队英文名对应的则是该团队在集群中的命名空间。此处填写  istio-system 。

![image-20211212203716453](https://ghproxy.com/https://raw.githubusercontent.com/yangkaa/images/main/works/image-20211212203716453.png)

#### 2. Docking store

Rainbond supports direct deployment of applications based on helm, so the next step is to connect to the official Rainbond helm warehouse, and then deploy Istio based on the Helm store. On the application market page, click Add store, select the helm store, and enter the relevant information to complete the connection.

Store Address：https://openchart.goodrain.com/goodrain/rainbond

![image-20211212203208140](https://ghproxy.com/https://raw.githubusercontent.com/yangkaa/images/main/works/image-20211212203208140.png)

#### 3. Install the Istio control plane

After the store is created, you can see the corresponding helm application. Currently, Rainbond provides the helm package of version 1.11.4 of [. According to the official](https://istio.io/latest/docs/releases/supported-releases/)document1, this version supports Kubernetes cluster versions 1.19, 1.20, 1.21, 1.22 .

- Install the base app

  Select the base application in the helm store to deploy, and the team selects the previously created team whose namespace is istio-system.This application package mainly deploys Istio-related cluster resources and CRD resources.该应用包主要部署了Istio相关的集群资源和 CRD 资源。

  ![image-20211212204419466](https://ghproxy.com/https://raw.githubusercontent.com/yangkaa/images/main/works/image-20211212204419466.png)

- Install the istio-discovery app\*\*

  同上述base应用一样，选择正确的团队。安装 istio-discovery 应用。As with the base app above, select the correct team.Install the istio-discovery app.With these two applications, you can have the governance capabilities of Istio.

### The sample application enables Istio governance mode

#### 1. Switch governance mode

Let's take the SpringBoot background management system [Ruoyi](https://gitee.com/y_project/RuoYi) as an example, as shown in the figure below, users can first install a `Ruoyi SpringBoot` application from the open source application store, select the version 3.6.0, click the governance mode switch, and select the Istio governance mode.

![image-20211212205811460](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/network.jpg)

After clicking to switch to the Istio governance mode, the user needs to manually set the internal domain name. The internal domain name here will be the service name of the component in the Kubernetes cluster, which is unique under the same team.Here we modify it to a more readable internal domain name.这里我们修改为可读性较高的内部域名。

![image-20211212210008895](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/model.png)

#### 2. Modify the configuration file

在这一步完成后，我们还需要进入 `ruoyi-ui` 挂载一个新的配置文件。After this step is completed, we also need to go to `ruoyi-ui` to mount a new configuration file.This is mainly because by default, the back-end service address in the configuration file `web.conf`  of`ruoyi-ui` is 127.0.0.1. When using Rainbond's built-in ServiceMesh mode, Rainbond will obtain the address of the back-end service. , inject it into `ruoyi-ui` , and give `ruoyi-ui` a local access address (127.0.0.1) to access the backend service.So it can be used without modification.所以无需修改就能使用。

However, when the Istio governance mode is used, the components communicate through the internal domain name, so the corresponding proxy address needs to be modified by mounting the configuration file. The configuration file of`ruoyi-ui` can be accessed through the `Web terminal` on the upper right to access the container , copy the contents of the file `/app/nginx/conf.d/web.conf`.After modifying the proxy address, save it, as shown in the following figure.Earlier we set the internal domain name of the console to `ruoyi-admin`, so replace it with `ruoyi-admin`here.修改代理地址后保存，如下图所示。之前我们设置了控制台的内部域名为 `ruoyi-admin`，所以这里替换为 `ruoyi-admin`。

![image-20211212211158509](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/conf.jpg)

#### 3. Restart the app

在完成以上两步后，我们需要重启整个应用。After completing the above two steps, we need to restart the entire application.After starting the application, go to the component page to view, you should see that each component has a similar Sidecar container, which is the data plane of Istio. After the application is switched to the Istio governance mode, all the Components will be automatically injected into the corresponding sidecar container, no additional user settings are required.

至此，该应用已纳入Istio治理范围。So far, the application has been included in the scope of Istio governance.If users need more configuration of the application, they can refer to [Istio official document](https://istio.io/latest/docs/setup/getting-started/#dashboard) for expansion.

![image](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/dataplane.png)

### Monitor and manage Istio with Kiali

在之前的步骤中，我们使用 Istio 治理模式纳管了 [若依](https://gitee.com/y_project/RuoYi) 。接下来则带大家一起看看如何使用 Kiali 观测应用间的通信链路。在这一步中，用户需要有 [kubectl 命令](https://www.rainbond.com/docs/user-operations/tools/kubectl?channel=toutiao)。

#### 1. Install prometheus

在Istio中，各个组件通过暴露HTTP接口的方式让Prometheus定时抓取数据（采用了Exporters的方式）。In Istio, each component allows Prometheus to periodically capture data by exposing the HTTP interface (using the way of Exporters).Therefore, after the Istio control plane is installed, Prometheus needs to be deployed in the istio-system namespace, and the data source of each relevant indicator of the Istio component is configured in Prometheus by default.

As with the base app above, select the correct team and install the `Prometheus`app.

![image-20211214112547510](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/deploy-prometheus.png)

#### 2. Install kiali

[kiali](https://kiali.io/)provides a visual interface to monitor and manage Istio, which can display service topology relationships and configure services.

Install the kiali-operator app, same as the base app above, select the correct team.

The installation process will automatically create a Service, and the access port of kiali can be exposed in the form of a third-party component of the Rainbond platform.as shown below：如下图所示：

![image-20211212212924071](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/create-kiali-third-party.png)

Add an access port in the port interface, and after adding, open**external service**and use the generated gateway policy to access.

![image](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/port.jpg)

kiali requires an authentication token when logging in, use the following command to get token：

```bash
kubectl describe secret $(kubectl get secret -n istio-system | grep istiod-token |awk '{print $1}') -n istio-system
```

After accessing kiali, in the Applications column, select the namespace where the application is located, and you can see the application we just created.Click to enter, you can see the flow route as follows.点击进入，可以看到如下的流量路线。

![image-20211212213849724](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/overview.png)

在 Graph 一栏，也可以看到对应的应用内的流量请求。In the Graph column, you can also see the corresponding in-app traffic requests.For more configuration and related functions, please refer to [Kiali Official Documents](https://kiali.io/docs/installation/quick-start/)![image-20211212214035677](https://static.goodrain.com/docs/5.5/user-manual/app-manage/deploy-istio/display.png)

## Summarize

本文简单介绍了在Rainbond中使用Istio治理模式的操作。以及Rainbond与Istio治理模式的结合。Rainbond为用户提供了一个可选的插件体系，使用户可以根据自己的需求选择不同的Service Mesh框架。在与Istio的结合上，我们主要为用户完成了指定应用数据平面的注入。用户也可以通过该机制扩展自己所需的ServiceMesh框架。后续文章我们将详细讲解如何制作插件，尽请关注。
