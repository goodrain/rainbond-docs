---
title: Istio's landed practice under the Rainbond Service Mesh system
description: The service grid is the final form of the microservice architecture, but it is not easy to use because the structure is coupled, but deployment has not been decoupled.
slug: istio
image: https://static.goodrain.com/wechat/istio/istio.jpeg
---

Two years ago the Service Mesh (service grid) was touched, and many saw it as the final form of the microservice architecture, since it allowed for decoupling of business codes and microservice structures, that is to say, the business code did not need to be modified to achieve the microservice structure, but the decoupling was not yet complete enough and was inconvenient. Although the structure decoupled had not been deployed.

- The appropriate service Mesh framework cannot be selected according to different environments or client needs.
- It cannot be achieved without learning and using Service Mesh in the development environment, which is opened on demand.

## Plugins Service Mesh Architecture Implementation Ideology

The current mature ServiceMesh framework also has a lot but for users.There is no one-size-fits-all Service Mesh framework that can solve the problems of various scenarios.We therefore hope that for users he will only need to care for his own business code.Applied governance capacity can be expanded through different ServiceMesh frameworks.The user's business code is fully decoupled from the ServiceMesh framework.As shown in the graph below.Users can replace the ServiceMesh architecture used by an app at any time.Select the solution that best matches the business.

![image-20211211180131913](https://cdn.jsdelir.net/gh/yangkaa/images@main/works/image-20211211180131913.png)

Based on the above ideas, we can make microservices such as istio, linkerd, dapr, and so on a plugin that does not need to know at all the existence of the Service Mesh framework, but to handle business dependence, when delivered to the production or client environment, when some need is high and some need is fully functional and some clients are designated, so that different types of plugins can be opened according to the environment and client needs and when the service Mesh framework is problematic and switched at any time.In this way, the Mesh framework becomes an enabling tool, and the re-deployment of the old business system will soon open service governance capacity.

Rainbond, which is based on these ideas, has already implemented three service governance plugins in the current version.

- kubernetes Native Service Mode
- Service Mesh mode based on envoy
- Istio Service Governance Mode

Later on, we describe the process of using the Istio service governance model.

## Use Istio governance mode in practice

With these concepts, we can look at how Rainbod is associated with Istio.In Rainbond, users can set up different modes of governance for different applications, i.e. they can manage apps according to their needs by switching their governance modes.This has the advantage that users will not be bound by a particular ServiceMesh framework and will be able to quickly identify the ServiceMesh framework best suited to their current operations.

### Install Istio controls (control plane)

First, when switching to the Istio governance mode, if Istio's control is not installed, it will prompt that the corresponding control be installed.We therefore need to install Istio's mass, which need to be installed only once in a cluster, which provides a unified management entry to manage services under the Istio governance model.Finish configuration and so on.In conjunction with existing helm installation in Rainbond, we can easily install the corresponding components.

#### 1. Create team

In version 5.5.0, we support user namespace when creating a team.The default helm installation namespace is istio-system to reduce user configuration.We first need to create a corresponding team.As shown in the graph below.The English name of the team corresponds to the naming space of the team in the cluster.Enter istio-system here.

![image-20211212203716453](https://ghproxy.com/https://raw.githubusercontent.com/yangkaa/images/main/works/image-202112203716453.png)

#### Twinning shops

Rainbod supports direct deployment of the app based on helm, so it will then connect to the official helm warehouse, then Istio based on the Helm shop, on the App Market page, click on the Add Store, select helm store and enter the relevant information.

Shop address：https://openchart.foodrain.com/goodrain/rainbond

![image-20211212203208140](https://ghproxy.com/https://raw.githubusercontent.com/yangkaa/images/main/works/image-202112203208140.png)

#### 3. Install Istio Control Face

The helm app will be seen when the store is created and is currently available in Rainbond, which provides version 1.11.4 help packages, based on [Istio官方文档](https://istio.io/ latest/docs/releases/supported-releases/) for the Kubernetes cluster versions are 1.19, 1.20, 1.21, 1.22.

- Install base app

  Select the base app in the helm store to deploy and the team selects the previously created namespace as istio-system team.The package primarily deployed Istio's associated cluster and CRD resources.

  ![image-20211212204419466](https://ghproxy.com/https://raw.githubusercontent.com/yangkaa/images/main/works/image-202112204419466.png)

- Install istio-discovery app\*\*

  Selecting the right team as is the case with the above base application.Install istio-discovery app.With these two applications, it will be possible to have the governance capacity at the Istio base.

### Sample app on Istio governance mode

#### 1. Switch governance mode

We use SpringBoot Background Management System [若依](https://gitee.com/y_project/RuoYi) as an example. As shown in the graph below, users can first install a `follow SpringBoot` app, version 3.6.0, switch from Governance Mode to Istio Governance.

![image-20211212205811460](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-istio/network.jpg)

When switching to Istio governance mode, users will be required to manually set an internal domain name, and the internal domain name will be the service name of the component in the Kubernetes cluster, unique under the same team.Here we're changing to more readable internal domain names.

![image-20211212210008895](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-istio/model.png)

#### Modification of profiles

Once this step is completed, we also need to go to `ruoyi-ui` to mount a new configuration file.This is mainly due to the fact that by default, the backend service address in `web.conf` is 127.0.0.0.1 in the `ruoyi-ui` configuration file before using Rainbond built-in ServiceMesh mode, inject `ruoyi-ui` to the `ruoyi-ui` local access address (127.0.0.0.1) to the backend service.So it will be available without modification.

However, when using Istio governance mode, the component communicates via internal domain and therefore needs to change the proxy address by mounting the configuration file. The `ruoyi-ui` configuration can be accessed to the container by `WebTerminal` at the top right, copying the contents of the `/app/nginx/conf.d/web.conf`Save the proxy address after modification, as shown in the graph below.Previously, we set up an internal domain named `ruoyi-admin`, so instead of `ruoyi-admin`.

![image-20211212211158509](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-istio/conf.jpg)

#### 3. Restart app

After completing these two steps, we need to reboot the entire application.After launching the app, enter the component page to view it, and it should be possible to see that each component has a similar Sidecar container. This is the data face of Istio. When the app switches to Istio, all components under the app will automatically inject the corresponding Sidecar container, without additional user settings.

The application has thus been included in Istio governance.If users need to have more configuration for this app, they can expand by reference to [Istio官方文档](https://istio.io/latest/docs/setup/getting-started/#dashboard).

![image](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-istio/datalane.png)

### Monitor and manage Istio via Kiali

In previous steps, we managed [若依](https://gitee.com/y_project/RuoYi) using the Istio governance model.Then you will see how to use the Kiali observation link between applications.In this step, users need to have [kubectl command](https://www.rainbond.com/docs/user-operations/tools/kubectl?channel=toutiao).

#### 1. Install prometheus

In Istio, components routinely capture data by exposing HTTP interfaces (exporters).So once the Istio control plane installation has been completed, Prometheus needs to be deployed in the istio-system namespace to configure default data sources for the Istio components in Prometheus.

Like the above base app, select the right team to install the `Prometheus` app.

![image-20211214112547510](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-employ-istio/de-employ-prometheus.png)

#### 2. Install kiali

[kiali](https://kiali.io/) provides visualization interfaces to monitor and manage Istio, capable of displaying services and configuring services.

Install the kiali-operator app. Select the right team as the base app above.

The installation process will automatically create the Service, which will expose the kiali access port in the form of a third party component of the Rainbod platform.Figure： below

![image-20211212212924071](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-istio/cree-kali-third-party.png)

Add a port to the port interface, then open **External Service** using the generated gateway strategy.

![image](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-istio/port.jpg)

Auth token is required when kiali is logged in. Use the following command to get token：

```bash
kubtl description secret $(kubtl get secret -n istio-system | grep istiod-token |awk '{print $1}') -n istio-system
```

After visiting the kiali, in the application column, select the namespace in which we have just created the app.Tap into to see the traffic route below.

![image-20211212213849724](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/de-istio/overview.png)

Also see traffic requests within the app in the Grapph column.More configuration and related features refer to [Kiali官方文档](https://kiali.io/docs/installation/quick-start/)![image-20211212214035677](https://grstatic.oss-cn-shanghai.aliyuncs.com/docs/5.5/user-manual/app-manage/employ-istio/display.png)

## Summary

This paper briefly describes the use of the Istio governance model in Rainbond.As well as the integration of Rainbod with the Istio governance model.Rainbod provides users with an optional plugin system that allows users to choose a different service Mesh framework according to their needs.In conjunction with Istio, we have mainly completed the injection of the specified application data plane for users.Through this mechanism, users can also expand their own ServiceMesh framework.Follow up articles to give more details about how to make plugins. Please stay tuned.
